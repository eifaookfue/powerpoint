Token Bucket、Leaky Bucketとはどのようなものですか？

**Token Bucket**（トークンバケット）と**Leaky Bucket**（リーキーバケット）は、ネットワークやシステムで流量制御（Rate Limiting）を行う際に使われる**アルゴリズム**です。それぞれの特徴と動作を以下に詳しく説明します。

---

## **1. Token Bucket（トークンバケット）**

### **概要**
- **動作原理**:
  1. バケットにトークンが一定の速度で追加されます（例: 毎秒5トークン）。
  2. リクエストが発生するたびにトークンを1つ消費して処理を許可します。
  3. バケットが空の場合、新しいトークンが生成されるまでリクエストは拒否されます（または待機）。

- **バースト処理に対応**:
  - バケットにトークンが貯まっていれば、短時間で大量のリクエストを処理可能です（バーストを許容）。
  - トークンが貯まる上限を超えると、余分なトークンは捨てられます。

### **動作のイメージ**
```plaintext
+---------------+
| Token Bucket  |
+---------------+
| Max Tokens: 5 |  <- トークンの最大容量
| Add Rate: 1/s |  <- 1秒に1トークン追加
+---------------+

# シナリオ
- バケットに3トークンある状態で1リクエストを処理（残り2トークン）。
- 短期間で5リクエストが来ても、貯まっているトークン分は処理可能。
- バケットが空になると、新しいトークン生成を待つ。
```

### **適用例**
- **Nginxの`limit_req`**:
  ```nginx
  limit_req_zone $binary_remote_addr zone=req_zone:10m rate=5r/s;
  location / {
      limit_req zone=req_zone burst=10 nodelay;
  }
  ```
  - `rate=5r/s`: 1秒あたり5リクエストを許可。
  - `burst=10`: 最大10リクエストのバーストを許容。

### **特徴**
- **バースト対応**: 一定量のバーストを許容できる。
- **柔軟性**: 高トラフィックを吸収しつつ、通常時は安定した流量を維持。

---

## **2. Leaky Bucket（リーキーバケット）**

### **概要**
- **動作原理**:
  1. バケットにリクエストが追加されます。
  2. リクエストは一定の速度で処理され、バケットから「漏れ出す」ように排出されます。
  3. バケットが満杯の場合、新しいリクエストは拒否されます。

- **バースト処理を平滑化**:
  - トラフィックが急増しても、処理速度は一定のため安定します。
  - バーストを許容しないため、システム全体が安定したトラフィックで動作。

### **動作のイメージ**
```plaintext
+---------------+
| Leaky Bucket  |
+---------------+
| Max Size: 10  |  <- バケットの最大容量
| Leak Rate: 1/s|  <- 1秒に1リクエスト処理
+---------------+

# シナリオ
- バケットに5リクエストが追加される（まだ処理可能）。
- バケットが満杯の状態で新しいリクエストが来ると拒否。
- リクエストは1秒に1件ずつ処理される。
```

### **適用例**
- **一定速度のデータ転送**:
  - ネットワーク帯域を平準化するため、一定速度でパケットを送信。

### **特徴**
- **バースト非対応**: バースト処理を完全に防ぎ、リクエスト処理を平滑化。
- **安定性**: システムに安定した負荷を維持。

---

## **3. Token BucketとLeaky Bucketの比較**

| **項目**               | **Token Bucket**                                 | **Leaky Bucket**                                 |
|-----------------------|------------------------------------------------|------------------------------------------------|
| **目的**               | バーストを許容しつつ、流量を制御する                 | バーストを防ぎ、トラフィックを平滑化する             |
| **リクエスト処理**       | バケットにトークンがあれば即座に処理可能              | 一定の速度でのみ処理可能                          |
| **バースト処理**         | 許容（バケットにトークンが貯まっている場合）           | 許容しない                                       |
| **適用例**             | Webサーバーのリクエストレート制限                  | ネットワーク帯域の平準化                          |
| **動作イメージ**         | トークンがある限り、瞬間的に大量のリクエストを処理       | 処理速度が一定で、急増したリクエストは排除される      |

---

## **4. どちらを使うべきか？**

- **Token Bucket**:
  - バーストを許容しつつ、一定の流量を維持したい場合。
  - WebアプリケーションやAPIのリクエスト制御に適している。

- **Leaky Bucket**:
  - トラフィックを平滑化し、安定した処理を行いたい場合。
  - ネットワークデータ転送やストリーム処理に適している。

---

## **まとめ**
- **Token Bucket**: 短期間の高負荷を吸収しつつ、通常時は安定した制御を提供。
- **Leaky Bucket**: 処理速度を一定に保ち、システム全体を安定化。
- システムの要件（バースト対応が必要かどうか）に応じて適切なアルゴリズムを選択します。